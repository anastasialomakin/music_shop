{% extends "base.html" %}
{% block content %}
<h2>–ö–∞—Ç–∞–ª–æ–≥ —Ä–µ–ª–∏–∑–æ–≤</h2>
<div class="catalog-container">
    <aside class="filters-sidebar">
        <h4>–§–∏–ª—å—Ç—Ä—ã</h4>
        <form method="get" action="{{ url_for('index') }}" class="filters-form">

            <label for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <select name="sort" id="sort">
                <option value="title_asc" {% if selected_sort == 'title_asc' %}selected{% endif %}>–ê ‚Üí –Ø</option>
                <option value="title_desc" {% if selected_sort == 'title_desc' %}selected{% endif %}>–Ø ‚Üí –ê</option>
                <option value="year_asc" {% if selected_sort == 'year_asc' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ ‚Üí –Ω–æ–≤—ã–µ</option>
                <option value="year_desc" {% if selected_sort == 'year_desc' %}selected{% endif %}>–ù–æ–≤—ã–µ ‚Üí —Å—Ç–∞—Ä—ã–µ</option>
            </select>

            <label for="band">–ì—Ä—É–ø–ø–∞:</label>
            <select name="band" id="band">
                <option value="">–í—Å–µ</option>
                {% for band in bands %}
                    <option value="{{ band.id }}" {% if band.id == selected_band %}selected{% endif %}>{{ band.name }}</option>
                {% endfor %}
            </select>

            <label for="genre">–ñ–∞–Ω—Ä:</label>
            <select name="genre" id="genre">
                <option value="">–í—Å–µ</option>
                {% for genre in genres %}
                    <option value="{{ genre.id }}" {% if genre.id == selected_genre %}selected{% endif %}>{{ genre.name }}</option>
                {% endfor %}
            </select>

            <label for="year_min">–ì–æ–¥ –æ—Ç:</label>
            <input type="number" name="year_min" id="year_min" value="{{ year_min or '' }}" style="width:48%; padding:8px; border:1px solid #ddd; border-radius:5px; display:inline-block; margin-right:4%;">

            <label for="year_max">–ì–æ–¥ –¥–æ:</label>
            <input type="number" name="year_max" id="year_max" value="{{ year_max or '' }}" style="width:48%; padding:8px; border:1px solid #ddd; border-radius:5px; display:inline-block;">


            <div style="margin-top: 15px;">
                <button type="submit" class="btn-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="{{ url_for('index') }}" class="btn-reset" style="margin-left: 10px;">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
            </div>
        </form>
    </aside>

    <div class="catalog-main">
        <div class="search-container">
            <form method="get" action="{{ url_for('index') }}" class="search-form" autocomplete="off">
                <input id="search-input" type="search" name="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –≥—Ä—É–ø–ø–µ..." value="{{ search_query or '' }}">
                <button type="submit">üîç</button>
                <ul id="suggestions" class="suggestions-list" style="display:none;"></ul>
            </form>
        </div>

        <script>
        const searchInput = document.getElementById('search-input');
        const suggestionsList = document.getElementById('suggestions');

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (!query) {
                suggestionsList.style.display = 'none';
                suggestionsList.innerHTML = '';
                return;
            }

            fetch(`/search_suggestions?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    suggestionsList.innerHTML = '';
                    if (data.length === 0) {
                        suggestionsList.style.display = 'none';
                        return;
                    }
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        li.style.padding = '5px 10px';
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            searchInput.value = item;
                            suggestionsList.style.display = 'none';
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsList.style.display = 'block';
                });
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-container')) {
                suggestionsList.style.display = 'none';
            }
        });
        </script>

        <div class="catalog-grid">
            {% if releases|length == 0 %}
                <p style="font-size: 1.2em; color: #004085; margin-top: 30px; text-align: center; width: 100%;">
                    –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.
                </p>
            {% else %}
                {% for release in releases %}
                    <div class="record-card">
                        <a href="{{ url_for('release_detail', id=release.id) }}" style="text-decoration: none; color: inherit;">
                            <img src="{{ url_for('uploaded_file', filename=release.cover_image_url) if release.cover_image_url else 'https://via.placeholder.com/200' }}" alt="–û–±–ª–æ–∂–∫–∞ —Ä–µ–ª–∏–∑–∞">
                            <h3>{{ release.title }}</h3>
                            <p>{{ release.band.name }}</p>
                        </a>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination" style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 20px;">
            {% for p in range(1, pagination.pages + 1) %}
                {% if p == pagination.page %}
                    <span style="padding: 8px 12px; background-color: #007bff; color: white; border-radius: 4px; font-weight: bold; cursor: default;">
                        {{ p }}
                    </span>
                {% else %}
                    <a href="{{ url_for('index', page=p, band=selected_band, genre=selected_genre, sort=selected_sort, year_min=year_min, year_max=year_max, q=search_query) }}" style="padding: 8px 12px; background-color: #e2e6ea; color: #333; border-radius: 4px; text-decoration: none;">
                        {{ p }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
